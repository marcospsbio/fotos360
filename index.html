<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Fotos 360 + Mapa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>

<style>
html, body { margin:0; height:100%; font-family: Arial, sans-serif; background:#000; }
#mapView, #photoView { width:100%; height:100%; }
.hidden { display:none; }

#map { width:100%; height:100%; }

#viewer { width:100%; height:100%; position:relative; }

#miniMap {
  position:absolute;
  left:14px;
  bottom:14px;
  width:160px;
  height:110px;
  border-radius:12px;
  overflow:hidden;
  border:2px solid rgba(255,255,255,.65);
  box-shadow:0 8px 22px rgba(0,0,0,.35);
  z-index: 9000;
  background:#111;
}
@media (max-width: 600px){
  #miniMap { width:120px; height:80px; } /* menor no celular */
}

.topbar {
  position:absolute;
  left:10px;
  top:10px;
  display:flex;
  gap:10px;
  z-index: 9000;
}
.btn {
  background: rgba(0,0,0,.55);
  color:#fff;
  border:1px solid rgba(255,255,255,.25);
  padding:8px 12px;
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
  backdrop-filter: blur(6px);
}
.badge {
  background: rgba(0,0,0,.55);
  color:#fff;
  border:1px solid rgba(255,255,255,.25);
  padding:8px 10px;
  border-radius:12px;
  font-size:14px;
}

.divisa-dot {
  width:6px; height:6px;
  background:red;
  border-radius:50%;
  box-shadow: 0 0 8px red;
}

#debug {
  position:fixed;
  left:10px;
  bottom:10px;
  background: rgba(0,0,0,0.70);
  color: #2bff2b;
  padding:6px 10px;
  font-size:12px;
  z-index: 9999;
  border-radius: 8px;
}
</style>
</head>
<body>

<div id="mapView">
  <div id="map"></div>
</div>

<div id="photoView" class="hidden">
  <div id="viewer"></div>

  <div class="topbar">
    <div class="badge" id="photoName">Foto</div>
    <button class="btn" id="backBtn">Voltar ao mapa</button>
    <button class="btn" id="fsBtn">Tela cheia</button>
  </div>

  <div id="miniMap" title="Clique para voltar ao mapa"></div>
</div>

<div id="debug">Carregandoâ€¦</div>

<script>
/* ===== CONFIG ===== */
const OWNER  = "marcospsbio";
const REPO   = "fotos360";
const BRANCH = "main";
const FOTOS_DIR = "fotos";

const DEFAULT_CENTER = [-23.0000, -47.0000]; // fallback se nada tiver
const DEFAULT_ZOOM = 17;

/* ===== STATE ===== */
let map, miniMap, viewer;
let CAL = {};
let DIVISA = null;
let divisaLayer = null;
let photoMarkerLayer = null;
let currentPhoto = null;

/* ===== UTILS ===== */
const dbg = (t) => document.getElementById("debug").innerText = t;

function bearingDeg(lat1, lon1, lat2, lon2){
  const toRad = d => d * Math.PI/180;
  const toDeg = r => r * 180/Math.PI;
  const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
  const Î”Î» = toRad(lon2 - lon1);
  const y = Math.sin(Î”Î») * Math.cos(Ï†2);
  const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
  let brng = toDeg(Math.atan2(y, x));
  return (brng + 360) % 360;
}
function bearingToYaw(bearing, yawOff){
  let yaw = bearing + (yawOff || 0);
  return ((yaw + 540) % 360) - 180;
}
function getCalForPhoto(photoSrc){
  const keys = [
    photoSrc,
    photoSrc.replace(/^\.?\//, ""),
    photoSrc.split("/").pop()
  ];
  for (const k of keys) if (CAL[k]) return CAL[k];
  return null;
}

/* ===== LOADERS ===== */
async function loadJSONNoCache(url){
  const u = `${url}?v=${Date.now()}`;
  const r = await fetch(u, { cache: "no-store" });
  return await r.json();
}
async function loadTextNoCache(url){
  const u = `${url}?v=${Date.now()}`;
  const r = await fetch(u, { cache: "no-store" });
  return await r.text();
}

async function loadCalibracoes(){
  try {
    CAL = await loadJSONNoCache("./calibracoes.json");
  } catch(e){
    CAL = {};
  }
}

async function loadDivisa(){
  const txt = await loadTextNoCache("./property.kml");
  const xml = new DOMParser().parseFromString(txt, "text/xml");
  DIVISA = toGeoJSON.kml(xml);
}

async function listFotosViaGitHubAPI(){
  // API pÃºblica do GitHub: lista arquivos em /fotos
  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FOTOS_DIR}?ref=${BRANCH}&v=${Date.now()}`;
  const r = await fetch(url, { cache:"no-store" });
  if (!r.ok) throw new Error("GitHub API " + r.status);
  const arr = await r.json();
  return arr
    .filter(x => x.type === "file" && /\.(jpe?g|png)$/i.test(x.name))
    .map(x => ({
      name: x.name,
      src: `${FOTOS_DIR}/${x.name}`
    }));
}

/* ===== MAP LAYERS ===== */
function satelliteLayer(){
  // Esri World Imagery (satÃ©lite)
  return L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 20 }
  );
}

function drawDivisaOnMap(targetMap){
  if (!DIVISA) return null;
  const layer = L.geoJSON(DIVISA, {
    style: {
      color: "#2b83ff",
      weight: 3,
      fillOpacity: 0.12
    }
  }).addTo(targetMap);
  return layer;
}

function getDivisaCenter(){
  if (!DIVISA) return DEFAULT_CENTER;
  // pega o primeiro polÃ­gono
  for (const f of DIVISA.features) {
    if (f.geometry && f.geometry.type === "Polygon") {
      const coords = f.geometry.coordinates[0];
      let sumLat=0, sumLng=0, n=0;
      coords.forEach(p => { sumLng += p[0]; sumLat += p[1]; n++; });
      return [sumLat/n, sumLng/n];
    }
  }
  return DEFAULT_CENTER;
}

/* ===== PHOTO VIEW ===== */
function showMap(){
  document.getElementById("photoView").classList.add("hidden");
  document.getElementById("mapView").classList.remove("hidden");
  if (map) map.invalidateSize();
  dbg("Mapa");
}

function showPhoto(photo){
  currentPhoto = photo;
  document.getElementById("mapView").classList.add("hidden");
  document.getElementById("photoView").classList.remove("hidden");

  document.getElementById("photoName").innerText = photo.name;

  // recria viewer
  document.getElementById("viewer").innerHTML = "";
  viewer = pannellum.viewer("viewer", {
    type: "equirectangular",
    panorama: photo.src,
    autoLoad: true,
    showZoomCtrl: true,
    showFullscreenCtrl: true
  });

  viewer.on("load", () => {
    applyDivisaOverlay(photo);
  });

  // minimapa
  miniMap.setView(photo.latlng || getDivisaCenter(), 18);
  miniMap.eachLayer(l => {
    // mantÃ©m apenas tiles; remove vetores antigos
    if (l instanceof L.GeoJSON || l instanceof L.Marker) miniMap.removeLayer(l);
  });
  drawDivisaOnMap(miniMap);

  if (photo.latlng) {
    L.marker(photo.latlng).addTo(miniMap);
  }

  dbg("Foto aberta. (mini-mapa: clique para voltar)");
}

/* ===== OVERLAY NA FOTO ===== */
function applyDivisaOverlay(photo){
  const cal = getCalForPhoto(photo.src);
  if (cal) dbg("CalibraÃ§Ã£o encontrada âœ“");
  else dbg("âš ï¸ CalibraÃ§Ã£o NÃƒO encontrada (vai desenhar mesmo assim)");

  const yawOff = cal?.yawOffset || 0;
  const pitchOff = cal?.pitchOffset ?? -6;

  // hotspot de teste (sempre)
  viewer.addHotSpot({ pitch: 0, yaw: 0, cssClass: "divisa-dot" });

  if (!DIVISA || !photo.latlng) return;

  let coords = [];
  for (const f of DIVISA.features) {
    if (f.geometry?.type === "Polygon") { coords = f.geometry.coordinates[0]; break; }
  }

  const lat1 = photo.latlng[0], lon1 = photo.latlng[1];
  coords.forEach((p, i) => {
    const lon2 = p[0], lat2 = p[1];
    const brng = bearingDeg(lat1, lon1, lat2, lon2);
    const yaw = bearingToYaw(brng, yawOff);
    viewer.addHotSpot({
      id: "divisa_" + i,
      pitch: pitchOff,
      yaw: yaw,
      cssClass: "divisa-dot"
    });
  });
}

/* ===== INIT ===== */
async function init(){
  dbg("Carregando divisa + calibracoes...");
  await loadCalibracoes();
  await loadDivisa();

  // Mapa principal
  map = L.map("map", { zoomControl: true });
  satelliteLayer().addTo(map);
  divisaLayer = drawDivisaOnMap(map);

  const center = getDivisaCenter();
  map.setView(center, DEFAULT_ZOOM);

  // Mini mapa
  miniMap = L.map("miniMap", { zoomControl: false, attributionControl: false, dragging: true, scrollWheelZoom: true });
  satelliteLayer().addTo(miniMap);
  drawDivisaOnMap(miniMap);
  miniMap.setView(center, 18);
  document.getElementById("miniMap").addEventListener("click", showMap);

  // Lista fotos
  dbg("Carregando fotos...");
  let fotos = [];
  try {
    fotos = await listFotosViaGitHubAPI();
  } catch(e){
    dbg("âš ï¸ NÃ£o consegui listar fotos via GitHub API. Verifique OWNER/REPO/BRANCH/FOTOS_DIR.");
    fotos = [];
  }

  // Camada de marcadores (1 pino central provisÃ³rio; depois vocÃª coloca EXIF)
  photoMarkerLayer = L.layerGroup().addTo(map);

  // Se ainda nÃ£o tem EXIF, coloca o marcador no centro da divisa
  const fallbackLatLng = center;

  fotos.forEach(f => {
    // por enquanto usa centro da divisa (atÃ© vocÃª extrair EXIF e salvar lat/lng por foto)
    f.latlng = fallbackLatLng;

    const iconHtml = `
      <div style="
        width:34px;height:34px;border-radius:50%;
        background:rgba(0,0,0,.55);
        border:2px solid #fff;
        display:flex;align-items:center;justify-content:center;
        box-shadow:0 8px 18px rgba(0,0,0,.35);
      ">
        <div style="
          width:18px;height:18px;border-radius:4px;
          background:#2b83ff;
          clip-path: polygon(50% 0%, 100% 40%, 80% 100%, 20% 100%, 0% 40%);
        "></div>
      </div>
    `;

    const icon = L.divIcon({
      html: iconHtml,
      className: "",
      iconSize: [34, 34],
      iconAnchor: [17, 17]
    });

    const m = L.marker(f.latlng, { icon }).addTo(photoMarkerLayer);
    m.bindTooltip("ðŸ“· 360: " + f.name, { direction: "top", offset: [0, -10] });
    m.on("click", () => showPhoto(f));
  });

  // UI
  document.getElementById("backBtn").addEventListener("click", showMap);
  document.getElementById("fsBtn").addEventListener("click", () => viewer?.toggleFullscreen?.());

  dbg("OK. Clique no Ã­cone ðŸ“· 360 no mapa.");
}

init();
</script>

</body>
</html>
