<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Calibração 360 (Mapa + Foto)</title>

  <!-- Pannellum -->
  <link rel="stylesheet" href="https://unpkg.com/pannellum@2.5.6/build/pannellum.css"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#111;
      --card:#141414;
      --line:#222;
      --text:#fff;
      --muted:rgba(255,255,255,.75);
      --brand:#1f6feb;
      --danger:#ff4d4d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:10px 12px;background:var(--panel);position:sticky;top:0;z-index:50;border-bottom:1px solid var(--line)
    }
    header b{font-size:14px}
    header .status{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:55vw}
    main{
      display:grid;
      grid-template-columns:360px 1fr 1fr;
      grid-template-rows: calc(100vh - 52px);
      gap:0;
    }
    @media (max-width: 1100px){
      main{grid-template-columns:360px 1fr;grid-template-rows: 50vh 50vh;}
      #map{grid-column:2;grid-row:2}
      #panoWrap{grid-column:2;grid-row:1}
    }
    @media (max-width: 820px){
      main{grid-template-columns:1fr;grid-template-rows:auto 48vh 48vh;}
      #controls{grid-column:1}
      #panoWrap{grid-column:1}
      #map{grid-column:1}
      header .status{max-width:70vw}
    }

    #controls{border-right:1px solid var(--line);padding:12px;overflow:auto;background:var(--panel)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
    .row{margin:10px 0}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,button{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid #333;background:#101010;color:var(--text)
    }
    button{cursor:pointer}
    .btn{background:var(--brand);border:0}
    .btn2{background:#1a1a1a;border:1px solid #333}
    .btnDanger{background:var(--danger);border:0}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .small{font-size:11px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#0f0f0f;color:var(--muted);font-size:11px}

    #panoWrap{position:relative;border-right:1px solid var(--line)}
    #pano{width:100%;height:100%}
    #map{width:100%;height:100%}

    /* Overlay label over pano */
    .overlayTop{
      position:absolute;left:10px;top:10px;z-index:10;display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      background:rgba(0,0,0,.45);backdrop-filter: blur(6px);
      padding:8px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.15)
    }
    .overlayTop b{font-size:12px}
    .overlayTop .kv{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:11px;padding:2px 6px;border:1px solid rgba(255,255,255,.15);border-radius:8px;background:rgba(0,0,0,.25);color:var(--muted)}
  </style>
</head>
<body>

<header>
  <div style="display:flex;gap:10px;align-items:center">
    <b>Admin — Calibração 360</b>
    <span class="pill">Mapa + Foto</span>
  </div>
  <div id="status" class="status">Carregue e sincronize a direção da foto com o cone no mapa.</div>
</header>

<main>
  <aside id="controls">
    <div class="card">
      <div class="row">
        <label>Senha do Admin</label>
        <input id="pwd" type="password" placeholder="Digite a senha"/>
      </div>
      <button class="btn" id="btnLogin">Entrar</button>
      <div class="hint small" style="margin-top:10px">
        Aviso: em GitHub Pages isso é apenas uma <b>trava visual</b>.
      </div>
    </div>

    <div class="card" id="adminUI" style="display:none">
      <div class="row">
        <label>Foto</label>
        <select id="fotoSel"></select>
      </div>

      <div class="row">
        <button class="btn" id="btnSync">✅ Sincronizado (calcular yawOffset)</button>
        <div class="hint" style="margin-top:8px">
          Use o <b>cone no mapa</b> para apontar a direção que a foto está olhando (a direção do “centro” da tela). Depois clique em <b>Sincronizado</b>.
        </div>
      </div>

      <div class="row">
        <label>Altura da câmera (m)</label>
        <input id="altura" type="number" step="0.1" value="60">
      </div>

      <div class="row">
        <label>Ajuste fino (Pitch offset, graus)</label>
        <input id="pitchOff" type="range" min="-30" max="30" value="0">
        <div class="hint">Valor: <span id="pitchVal">0</span>°</div>
      </div>

      <div class="row">
        <label>Yaw offset calculado (graus)</label>
        <input id="yawOff" type="number" step="0.1" value="0" readonly>
        <div class="hint small">Esse valor é usado depois para projetar a divisa sobre a foto.</div>
      </div>

      <div class="row" style="display:flex;gap:10px">
        <button class="btn2" id="btnAplicar" style="flex:1">Aplicar pitch</button>
        <button class="btn" id="btnSalvar" style="flex:1">Salvar desta foto</button>
      </div>

      <div class="row" style="display:flex;gap:10px">
        <button class="btn2" id="btnBaixar" style="flex:1">Baixar calibracoes.json</button>
        <button class="btnDanger" id="btnLimpar" style="flex:1">Limpar desta foto</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Dica: no mapa, você pode <span class="kbd">arrastar</span> o ponto para ajustar a posição da foto (se EXIF vier errado) e pode <span class="kbd">arrastar</span> a ponta do cone para ajustar o azimute.
      </div>
    </div>
  </aside>

  <section id="panoWrap">
    <div class="overlayTop">
      <b>Foto</b>
      <span class="kv" id="panoInfo">—</span>
      <span class="kbd">arraste</span>
      <span class="kbd">scroll</span>
    </div>
    <div id="pano"></div>
  </section>

  <section id="map"></section>
</main>

<!-- Libs -->
<script src="https://unpkg.com/pannellum@2.5.6/build/pannellum.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/exifr@7.1.3/dist/lite.umd.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>

<script>
  // ===== CONFIG =====
  const GITHUB_OWNER = "marcospsbio";
  const GITHUB_REPO  = "foto360";
  const BRANCH       = "main";
  const FOTOS_DIR    = "fotos";      // pasta com suas fotos
  const KML_FILE     = "property.kml"; // na raiz
  const ADMIN_PASSWORD = "1234";

  // ===== State =====
  let fotos = [];            // [{name,url}]
  let calibracoes = {};      // { "DJI_0210.JPG": { yawOff, pitchOff, altura, lat, lng } }
  let viewer = null;

  // Map state
  let map, baseSat;
  let kmlLayer = null;
  let fotoMarker = null;
  let coneLine = null;
  let coneHandle = null;
  let coneBearing = 0; // graus 0..360
  let fotoLatLng = null;

  // ===== UI =====
  const statusEl = document.getElementById("status");
  const adminUI  = document.getElementById("adminUI");
  const pwdEl    = document.getElementById("pwd");
  const fotoSel  = document.getElementById("fotoSel");

  const yawOffEl   = document.getElementById("yawOff");
  const pitchOffEl = document.getElementById("pitchOff");
  const pitchValEl = document.getElementById("pitchVal");
  const alturaEl   = document.getElementById("altura");
  const panoInfoEl = document.getElementById("panoInfo");

  function setStatus(t){ statusEl.textContent = t; }

  function norm180(a){
    // retorna [-180,180)
    a = ((a + 540) % 360) - 180;
    return a;
  }
  function norm360(a){
    a = ((a % 360) + 360) % 360;
    return a;
  }

  async function listFotos(){
    const api = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FOTOS_DIR}?ref=${BRANCH}`;
    const r = await fetch(api, { cache:"no-store" });
    if(!r.ok) throw new Error("API GitHub falhou HTTP " + r.status);
    const items = await r.json();
    return items
      .filter(it => it.type==="file" && /\.(jpg|jpeg|png|webp)$/i.test(it.name))
      .sort((a,b)=> a.name.localeCompare(b.name, "pt-BR", {numeric:true, sensitivity:"base"}))
      .map(it => ({ name: it.name, url: it.download_url }));
  }

  async function loadCalibracoes(){
    try{
      const r = await fetch("./calibracoes.json", { cache:"no-store" });
      if(r.ok) calibracoes = await r.json();
    }catch(e){}
  }

  async function loadKml(){
    try{
      const r = await fetch("./" + KML_FILE, { cache:"no-store" });
      if(!r.ok) throw new Error("Não consegui carregar " + KML_FILE);
      const text = await r.text();
      const xml = new DOMParser().parseFromString(text, "text/xml");
      const gj = toGeoJSON.kml(xml);
      if(kmlLayer) map.removeLayer(kmlLayer);
      kmlLayer = L.geoJSON(gj, { style: { color:"#2a74ff", weight:3, fillOpacity:0.10 } }).addTo(map);
      try{ map.fitBounds(kmlLayer.getBounds(), { padding:[30,30] }); }catch(e){}
    }catch(e){
      setStatus("KML: " + e.message);
    }
  }

  function initMap(){
    map = L.map("map", { zoomControl: true, preferCanvas: true });

    // Satélite (ESRI)
    baseSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20, attribution: "Tiles © Esri" }
    ).addTo(map);

    // fallback view
    map.setView([-23.0, -47.0], 12);

    // Cone (linha + handle)
    coneLine = L.polyline([[0,0],[0,0]], { color:"#ff3b3b", weight:4, opacity:0.9 }).addTo(map);
    coneHandle = L.marker([0,0], {
      draggable:true,
      icon: L.divIcon({ className:"", html:`<div style="
        width:18px;height:18px;border-radius:50%;
        background:rgba(255,59,59,.95);
        border:2px solid rgba(255,255,255,.9);
        box-shadow:0 0 12px rgba(255,59,59,.85);
      " title="Arraste para ajustar a direção"></div>` })
    }).addTo(map);

    coneHandle.on("drag", () => {
      if(!fotoLatLng) return;
      const from = fotoLatLng;
      const to = coneHandle.getLatLng();
      coneBearing = bearingDeg(from.lat, from.lng, to.lat, to.lng);
      updateConeGraphics();
    });

    map.on("click", (e) => {
      // clique no mapa ajusta direção rapidamente (coloca handle no clique)
      if(!fotoLatLng) return;
      coneHandle.setLatLng(e.latlng);
      coneBearing = bearingDeg(fotoLatLng.lat, fotoLatLng.lng, e.latlng.lat, e.latlng.lng);
      updateConeGraphics();
    });

    loadKml();
  }

  // bearing em graus (0=N, 90=E)
  function bearingDeg(lat1, lon1, lat2, lon2){
    const toRad = d => d * Math.PI/180;
    const toDeg = r => r * 180/Math.PI;
    const φ1 = toRad(lat1), φ2 = toRad(lat2);
    const Δλ = toRad(lon2 - lon1);
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    let brng = toDeg(Math.atan2(y, x));
    brng = (brng + 360) % 360;
    return brng;
  }

  function destPoint(lat, lng, bearing, distMeters){
    // destino aproximado (esfera)
    const R = 6371000;
    const toRad = d => d*Math.PI/180;
    const toDeg = r => r*180/Math.PI;

    const φ1 = toRad(lat);
    const λ1 = toRad(lng);
    const θ = toRad(bearing);
    const δ = distMeters / R;

    const φ2 = Math.asin(Math.sin(φ1)*Math.cos(δ) + Math.cos(φ1)*Math.sin(δ)*Math.cos(θ));
    const λ2 = λ1 + Math.atan2(Math.sin(θ)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
    return { lat: toDeg(φ2), lng: toDeg(λ2) };
  }

  function ensureFotoMarker(latlng){
    fotoLatLng = latlng;

    if(!fotoMarker){
      fotoMarker = L.marker(latlng, {
        draggable:true,
        icon: L.divIcon({ className:"", html:`<div style="
          width:20px;height:20px;border-radius:10px;
          background:rgba(31,111,235,.95);
          border:2px solid rgba(255,255,255,.95);
          box-shadow:0 0 12px rgba(31,111,235,.8);
        " title="Posição da foto (arraste se precisar)"></div>` })
      }).addTo(map);

      fotoMarker.on("drag", () => {
        fotoLatLng = fotoMarker.getLatLng();
        updateConeGraphics(true);
      });
    }else{
      fotoMarker.setLatLng(latlng);
    }

    // coloca cone handle a 120m na direção atual
    updateConeGraphics(true);
  }

  function updateConeGraphics(resetHandle=false){
    if(!fotoLatLng) return;

    const from = fotoLatLng;
    const to = destPoint(from.lat, from.lng, coneBearing, 120); // 120m visual
    coneLine.setLatLngs([from, to]);

    if(resetHandle){
      coneHandle.setLatLng(to);
    }
  }

  function loadPano(url){
    if(viewer){
      try{ viewer.destroy(); }catch(e){}
      document.getElementById("pano").innerHTML = "";
    }
    viewer = pannellum.viewer("pano", {
      type: "equirectangular",
      panorama: url,
      autoLoad: true,
      showZoomCtrl: true,
      mouseZoom: true,
      hfov: 100,
      minHfov: 3,
      maxHfov: 170
    });

    viewer.on("load", () => {
      setStatus("Foto carregada. Gire a foto e ajuste o cone no mapa. Depois clique em Sincronizado.");
      applyPitch();
    });

    // Atualiza info de yaw em tempo real (leve, sem spam)
    let t = null;
    viewer.on("animatefinished", () => {
      if(t) clearTimeout(t);
      t = setTimeout(() => {
        const yaw = norm360(viewer.getYaw());
        panoInfoEl.textContent = `yaw foto: ${yaw.toFixed(1)}° | cone mapa: ${coneBearing.toFixed(1)}°`;
      }, 60);
    });
  }

  async function readExifLatLng(url){
    // exifr consegue ler GPS diretamente do arquivo via fetch
    try{
      const gps = await exifr.gps(url);
      if(gps && typeof gps.latitude === "number" && typeof gps.longitude === "number"){
        return { lat: gps.latitude, lng: gps.longitude };
      }
    }catch(e){}
    return null;
  }

  async function selectFoto(name){
    const f = fotos.find(x=>x.name===name);
    if(!f) return;

    // aplica calibração existente
    const c = calibracoes[name];
    yawOffEl.value = c?.yawOff ?? 0;
    pitchOffEl.value = c?.pitchOff ?? 0;
    pitchValEl.textContent = String(pitchOffEl.value);
    alturaEl.value = c?.altura ?? 60;

    panoInfoEl.textContent = "carregando…";
    loadPano(f.url);

    // posiciona foto no mapa (EXIF ou calibração)
    if(c?.lat && c?.lng){
      ensureFotoMarker({lat:c.lat, lng:c.lng});
      map.setView([c.lat, c.lng], 17);
    }else{
      const ll = await readExifLatLng(f.url);
      if(ll){
        ensureFotoMarker(ll);
        map.setView([ll.lat, ll.lng], 17);
      }else{
        setStatus("⚠️ Não achei GPS no EXIF. Arraste o ponto azul para a posição correta.");
        // deixa o ponto no centro atual do mapa
        ensureFotoMarker(map.getCenter());
      }
    }

    // se tinha bearing salvo, restaura cone
    if(c?.coneBearing != null){
      coneBearing = norm360(c.coneBearing);
      updateConeGraphics(true);
    }
  }

  function applyPitch(){
    if(!viewer) return;
    const p = Number(pitchOffEl.value || 0);
    viewer.setPitch(p);
  }

  function syncYawOffset(){
    if(!viewer) return;
    // regra: yaw = bearing + yawOff  => yawOff = yaw - bearing
    const yaw = norm360(viewer.getYaw());
    const yawOff = norm180(yaw - coneBearing);
    yawOffEl.value = yawOff.toFixed(1);
    panoInfoEl.textContent = `yaw foto: ${yaw.toFixed(1)}° | cone mapa: ${coneBearing.toFixed(1)}°`;
    setStatus("YawOffset calculado ✓ Agora clique em Salvar desta foto.");
  }

  function salvar(){
    const name = fotoSel.value;
    calibracoes[name] = {
      yawOff: Number(yawOffEl.value || 0),
      pitchOff: Number(pitchOffEl.value || 0),
      altura: Number(alturaEl.value || 0),
      lat: fotoLatLng?.lat ?? null,
      lng: fotoLatLng?.lng ?? null,
      coneBearing: Number(coneBearing || 0),
      updatedAt: new Date().toISOString()
    };
    setStatus("Salvo ✓ " + name);
  }

  function limparFoto(){
    const name = fotoSel.value;
    delete calibracoes[name];
    yawOffEl.value = 0;
    pitchOffEl.value = 0;
    pitchValEl.textContent = "0";
    setStatus("Limpo ✓ " + name);
  }

  function baixarJson(){
    const blob = new Blob([JSON.stringify(calibracoes, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "calibracoes.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ===== Events =====
  pitchOffEl.addEventListener("input", () => {
    pitchValEl.textContent = String(pitchOffEl.value);
  });

  document.getElementById("btnAplicar").addEventListener("click", applyPitch);
  document.getElementById("btnSync").addEventListener("click", syncYawOffset);
  document.getElementById("btnSalvar").addEventListener("click", salvar);
  document.getElementById("btnBaixar").addEventListener("click", baixarJson);
  document.getElementById("btnLimpar").addEventListener("click", limparFoto);

  fotoSel.addEventListener("change", () => selectFoto(fotoSel.value));

  document.getElementById("btnLogin").addEventListener("click", async ()=>{
    if(pwdEl.value !== ADMIN_PASSWORD){
      setStatus("Senha incorreta.");
      return;
    }
    adminUI.style.display = "block";
    setStatus("Carregando fotos…");

    try{
      initMap();
      await loadCalibracoes();
      fotos = await listFotos();

      fotoSel.innerHTML = fotos.map(f => `<option value="${f.name}">${f.name}</option>`).join("");
      setStatus(`OK ✓ ${fotos.length} foto(s). Ajuste o cone no mapa e a direção da foto.`);

      // inicializa coneBearing em 0 (N)
      coneBearing = 0;

      await selectFoto(fotoSel.value);
    }catch(e){
      setStatus("Erro: " + e.message);
    }
  });
</script>
</body>
</html>
