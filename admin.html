<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Admin – Calibração Foto 360</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<style>
html, body { height: 100%; margin: 0; background:#111; color:#eee; font-family: Arial; }

#login {
  position: fixed; inset: 0; background:#000c;
  display:flex; align-items:center; justify-content:center;
}
#loginBox {
  background:#111; padding:20px; border-radius:8px; width:300px;
}
input, select, button {
  width:100%; padding:8px; margin-top:8px;
  border-radius:5px; border:none;
}
button { background:#1f7aff; color:#fff; cursor:pointer; }

#app { display:none; height:100%; }

#top {
  padding:10px; background:#000;
  display:flex; gap:10px; align-items:center;
}

#main {
  display:flex; height:calc(100% - 60px);
}

#map { width:40%; height:100%; }
#viewer { width:60%; height:100%; }

#controls {
  position:absolute; top:70px; left:10px;
  background:#000c; padding:10px;
  border-radius:8px; z-index:999;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div id="loginBox">
    <h3>Admin – Calibração 360</h3>
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="entrar()">Entrar</button>
    <small style="color:#888">Login visual (GitHub Pages)</small>
  </div>
</div>

<div id="app">

<div id="top">
  Foto:
  <select id="fotoSelect"></select>

  Altura da câmera (m):
  <input type="number" id="altura" value="60" style="width:80px">

  Horizonte:
  <input type="range" id="pitch" min="-30" max="30" step="0.1" value="0">

  <button onclick="salvar()">Sincronizado</button>
  <button onclick="baixar()">Baixar calibracoes.json</button>
</div>

<div id="main">
  <div id="map"></div>
  <div id="viewer"></div>
</div>

</div>

<script>
const SENHA = "1234";

let map, viewer, cone;
let calibracoes = {};
let yawAtual = 0;

function entrar(){
  if(document.getElementById("senha").value === SENHA){
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="block";
    iniciar();
  } else alert("Senha incorreta");
}

async function iniciar(){
  // MAPA
  map = L.map('map').setView([-23.5,-47.5],16);

  L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 20 }
  ).addTo(map);

  // KML
  fetch("property.kml")
    .then(r=>r.text())
    .then(kml=>{
      const parser = new DOMParser();
      const kmlDoc = parser.parseFromString(kml, "text/xml");
      const geo = toGeoJSON.kml(kmlDoc);
      L.geoJSON(geo,{color:'cyan',weight:3}).addTo(map);
      map.fitBounds(L.geoJSON(geo).getBounds());
    });

  // CONE DE VISÃO
  cone = L.marker(map.getCenter(), { draggable:true }).addTo(map);
  cone.on('drag', atualizarYaw);

  // FOTO
  const fotos = await fetchFotos();
  const sel = document.getElementById("fotoSelect");
  fotos.forEach(f=>{
    const o = document.createElement("option");
    o.value = f;
    o.textContent = f;
    sel.appendChild(o);
  });

  carregarFoto();
  sel.onchange = carregarFoto;
  document.getElementById("pitch").oninput = atualizarPitch;
}

async function fetchFotos(){
  const r = await fetch("https://api.github.com/repos/marcospsbio/fotos360/contents/fotos");
  const j = await r.json();
  return j.filter(f=>f.name.match(/\.jpg$/i)).map(f=>f.path);
}

function carregarFoto(){
  const foto = document.getElementById("fotoSelect").value;
  if(viewer) viewer.destroy();

  viewer = pannellum.viewer('viewer',{
    type:'equirectangular',
    panorama: foto,
    autoLoad:true,
    showControls:true,
    yaw:yawAtual,
    pitch:0,
    hfov:110
  });
}

function atualizarYaw(){
  const c = map.getCenter();
  const p = cone.getLatLng();
  yawAtual = Math.atan2(p.lng-c.lng, p.lat-c.lat) * 180/Math.PI;
  viewer.setYaw(yawAtual);
}

function atualizarPitch(){
  viewer.setPitch(parseFloat(pitch.value));
}

function salvar(){
  const foto = document.getElementById("fotoSelect").value;
  calibracoes[foto] = {
    yawOffset: yawAtual,
    pitchOffset: parseFloat(pitch.value),
    altura: parseFloat(altura.value)
  };
  alert("Calibração salva (memória)");
}

function baixar(){
  const blob = new Blob([JSON.stringify(calibracoes,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "calibracoes.json";
  a.click();
}
</script>

<!-- KML → GEOJSON -->
<script src="https://unpkg.com/@tmcw/togeojson@0.16.0/dist/togeojson.umd.js"></script>

</body>
</html>
