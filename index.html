<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Foto 360 com Divisa</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: Arial, sans-serif;
}

#viewer {
  width: 100%;
  height: 100%;
}

.divisa-dot {
  width: 6px;
  height: 6px;
  background: red;
  border-radius: 50%;
  box-shadow: 0 0 6px red;
}

#debug {
  position: fixed;
  bottom: 10px;
  left: 10px;
  background: rgba(0,0,0,0.75);
  color: #0f0;
  padding: 6px 10px;
  font-size: 12px;
  z-index: 9999;
  border-radius: 6px;
}
</style>
</head>

<body>

<div id="viewer"></div>
<div id="debug">Inicializando…</div>

<script>
/* ===================== CONFIG ===================== */

const FOTO = {
  src: "fotos/DJI_0210.JPG",
  lat: -23.000000,   // <<< ajuste se quiser
  lng: -47.000000
};

/* ===================== VARIÁVEIS ===================== */

let CAL = {};
let DIVISA = null;
let viewer;

/* ===================== UTIL ===================== */

function logDebug(msg) {
  document.getElementById("debug").innerText = msg;
}

function bearingDeg(lat1, lon1, lat2, lon2){
  const toRad = d => d * Math.PI/180;
  const toDeg = r => r * 180/Math.PI;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) -
            Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  let brng = toDeg(Math.atan2(y, x));
  return (brng + 360) % 360;
}

function bearingToYaw(bearing, yawOff){
  let yaw = bearing + (yawOff || 0);
  return ((yaw + 540) % 360) - 180;
}

/* ===================== LOADERS ===================== */

async function loadCalibracoes(){
  const url = `./calibracoes.json?v=${Date.now()}`;
  const r = await fetch(url, { cache: "no-store" });
  CAL = await r.json();
}

async function loadDivisa(){
  const r = await fetch(`./property.kml?v=${Date.now()}`, { cache: "no-store" });
  const txt = await r.text();
  const xml = new DOMParser().parseFromString(txt, "text/xml");
  DIVISA = toGeoJSON.kml(xml);
}

/* ===================== DIVISA ===================== */

function addDivisaHotspots() {

  const keys = [
    FOTO.src,
    FOTO.src.replace(/^\.?\//, ""),
    FOTO.src.split("/").pop()
  ];

  let cal = {};
  for (const k of keys) {
    if (CAL[k]) { cal = CAL[k]; break; }
  }

  logDebug(
    Object.keys(cal).length
      ? "Calibração encontrada ✔"
      : "⚠️ Calibração NÃO encontrada"
  );

  const yawOff = cal.yawOffset || 0;
  const pitchOff = cal.pitchOffset || -6;

  // hotspot de teste (SEMPRE aparece)
  viewer.addHotSpot({
    pitch: 0,
    yaw: 0,
    cssClass: "divisa-dot"
  });

  if (!DIVISA) return;

  let coords = [];

  for (const f of DIVISA.features) {
    if (f.geometry?.type === "Polygon") {
      coords = f.geometry.coordinates[0];
      break;
    }
  }

  coords.forEach((p, i) => {
    const lon2 = p[0], lat2 = p[1];
    const brng = bearingDeg(FOTO.lat, FOTO.lng, lat2, lon2);
    const yaw = bearingToYaw(brng, yawOff);

    viewer.addHotSpot({
      id: "divisa_" + i,
      pitch: pitchOff,
      yaw: yaw,
      cssClass: "divisa-dot"
    });
  });
}

/* ===================== INIT ===================== */

async function init() {

  await loadCalibracoes();
  await loadDivisa();

  viewer = pannellum.viewer('viewer', {
    type: 'equirectangular',
    panorama: FOTO.src,
    autoLoad: true,
    showZoomCtrl: true,
    showFullscreenCtrl: true
  });

  viewer.on('load', () => {
    addDivisaHotspots();
  });
}

init();
</script>

</body>
</html>
